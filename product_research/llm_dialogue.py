import json
import os
import subprocess
import re
import argparse
import time
from pathlib import Path

# ============================================================
# –£–¢–ò–õ–ò–¢–´
# ============================================================

def normalize_text_line(text: str) -> str:
    """
    –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É —Ç–µ–∫—Å—Ç–∞:
    - –ø—Ä–∏–≤–æ–¥–∏–º ‚Äú–∫—Ä–∞—Å–∏–≤—ã–µ‚Äù –∫–∞–≤—ã—á–∫–∏ –∏ —Ç–∏—Ä–µ –∫ –æ–±—ã—á–Ω—ã–º,
    - —É–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã —Å—Ç—Ä–æ–∫,
    - —Å—Ö–ª–æ–ø—ã–≤–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã.
    –ü–æ–¥—Ö–æ–¥–∏—Ç –∏ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤.
    """
    if not text:
        return ""

    # –ü—Ä–∏–≤–æ–¥–∏–º –∫—Ä–∞—Å–∏–≤—ã–µ –∫–∞–≤—ã—á–∫–∏/—Ç–∏—Ä–µ –∫ –æ–±—ã—á–Ω—ã–º
    replacements = {
        "‚Äú": '"', "‚Äù": '"', "‚Äû": '"', "¬´": '"', "¬ª": '"',
        "‚Äô": "'", "‚Äò": "'",
        "‚Äî": "-", "‚Äì": "-",
    }
    for src, dst in replacements.items():
        text = text.replace(src, dst)

    # –ü–µ—Ä–µ–≤–æ–¥—ã —Å—Ç—Ä–æ–∫ -> –ø—Ä–æ–±–µ–ª
    text = text.replace("\r", " ").replace("\n", " ")

    # –°—Ö–ª–æ–ø—ã–≤–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
    text = re.sub(r"\s+", " ", text)

    return text.strip()


def clean_reply(raw: str, max_sentences: int = 3) -> str:
    """
    –ß–∏—Å—Ç–∏–º –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏:
    - —É–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã —Ä–æ–ª–µ–π –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏,
    - —É–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã —Å–ø–∏—Å–∫–æ–≤,
    - –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–∞–≤—ã—á–∫–∏/—Ç–∏—Ä–µ/–ø—Ä–æ–±–µ–ª—ã,
    - –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã + —Ü–∏—Ñ—Ä—ã + –±–∞–∑–æ–≤—É—é –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é,
    - –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º—Å—è 1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ (–Ω–æ –ù–ï —Ä–µ–∂–µ–º –ø–æ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ).
    """
    if not raw:
        return ""

    text = raw.strip()

    # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã —Ä–æ–ª–µ–π —Ç–æ–ª—å–∫–æ –≤ –ù–ê–ß–ê–õ–ï —Å—Ç—Ä–æ–∫–∏:
    # "–û–ø–µ—Ä–∞—Ç–æ—Ä: ..." / "–ú–µ–Ω–µ–¥–∂–µ—Ä: ..." / "Operator: ..." / "Manager: ..."
    text = re.sub(
        r"^\s*(–û–ø–µ—Ä–∞—Ç–æ—Ä|–ú–µ–Ω–µ–¥–∂–µ—Ä|Manager|Operator)\s*[:\-‚Äì]\s*",
        "",
        text,
        flags=re.IGNORECASE,
    )

    # –£–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã —Å–ø–∏—Å–∫–æ–≤ –≤ –Ω–∞—á–∞–ª–µ: "- ", "* ", "‚Ä¢ "
    text = re.sub(r"^\s*[\-\*\‚Ä¢]+\s*", "", text)

    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–∞–≤—ã—á–∫–∏/—Ç–∏—Ä–µ/–ø—Ä–æ–±–µ–ª—ã –∏ —É–±–∏—Ä–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
    text = normalize_text_line(text)

    # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –±–∞–∑–æ–≤—É—é –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é
    text = re.sub(r"[^–ê-–Ø–∞-—è–Å—ë0-9,.;:!?()\"'\-\s]", " ", text)
    text = re.sub(r"\s{2,}", " ", text).strip()

    if not text:
        return ""

    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (1‚Äì3), —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç –Ω–µ –±—ã–ª –ø–æ–ª–æ—Ç–Ω–æ–º
    # –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ . ! ? —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∑–Ω–∞–∫–∞
    parts = re.split(r'(?<=[.!?])\s+', text)
    if parts:
        text = " ".join(parts[:max_sentences]).strip()

    return text


def clean_manager_input(raw: str) -> str:
    """
    –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤–≤–æ–¥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:
    - —É–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã '–û–ø–µ—Ä–∞—Ç–æ—Ä:' / '–ú–µ–Ω–µ–¥–∂–µ—Ä:' –µ—Å–ª–∏ —Å–ª—É—á–∞–π–Ω–æ –ø–æ–ø–∞–ª–∏,
    - –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–∞–≤—ã—á–∫–∏/—Ç–∏—Ä–µ/–ø—Ä–æ–±–µ–ª—ã.
    –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –∫–æ–ø–∏–ø–∞—Å—Ç–∏—Ç—å —Ñ—Ä–∞–∑—ã –∏–∑ –ª–æ–≥–æ–≤ –æ–±—Ä–∞—Ç–Ω–æ –≤ –∫–æ–Ω—Å–æ–ª—å,
    –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω—ã–π.
    """
    if not raw:
        return ""

    text = raw.strip()

    # –°—Ä–µ–∑–∞–µ–º '–û–ø–µ—Ä–∞—Ç–æ—Ä:' –∏–ª–∏ '–ú–µ–Ω–µ–¥–∂–µ—Ä:' –≤ –Ω–∞—á–∞–ª–µ
    text = re.sub(
        r"^\s*(–û–ø–µ—Ä–∞—Ç–æ—Ä|–ú–µ–Ω–µ–¥–∂–µ—Ä)\s*[:\-‚Äì]\s*",
        "",
        text,
        flags=re.IGNORECASE,
    )

    text = normalize_text_line(text)
    return text


def normalize_phrases(raw):
    """
    –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ —Ñ—Ä–∞–∑ –∏–∑ JSON –≤ —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ –∏ –æ–±—ä–µ–∫—Ç—ã –≤–∏–¥–∞ {"text": "..."}.
    """
    if not raw:
        return []
    out = []
    for item in raw:
        if isinstance(item, str):
            out.append(item)
        elif isinstance(item, dict):
            v = item.get("text") or item.get("phrase") or item.get("value")
            if isinstance(v, str):
                out.append(v)
    return [x for x in out if x]


# ============================================================
# AIDA-–≠–¢–ê–ü –ü–û –ö–û–õ–ò–ß–ï–°–¢–í–£ –•–û–î–û–í –ú–ï–ù–ï–î–ñ–ï–†–ê
# ============================================================

def detect_stage(manager_turns: int) -> str:
    """
    –ì—Ä—É–±–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ:
    1-–π —Ö–æ–¥ –º–µ–Ω–µ–¥–∂–µ—Ä–∞  -> attention
    2‚Äì3-–π              -> interest
    4‚Äì6-–π              -> desire
    7+                 -> action
    """
    if manager_turns <= 1:
        return "attention"
    if manager_turns <= 3:
        return "interest"
    if manager_turns <= 6:
        return "desire"
    return "action"


# ============================================================
# –ó–ê–ì–†–£–ó–ö–ê –°–¶–ï–ù–ê–†–ò–Ø
# ============================================================

def load_scenario(name: str):
    base = Path("scenarios")
    matches = list(base.rglob(f"{name}.json"))
    if not matches:
        raise FileNotFoundError(f"‚ùå –°—Ü–µ–Ω–∞—Ä–∏–π '{name}' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
    json_path = matches[0]

    md_path = Path("src/prompts/dialog_agent") / f"{name}.md"
    if not md_path.exists():
        raise FileNotFoundError(f"‚ùå Markdown-–ø—Ä–æ–º–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: {md_path}")

    with open(json_path, "r", encoding="utf-8") as f:
        scenario = json.load(f)
    with open(md_path, "r", encoding="utf-8") as f:
        md = f.read()

    return scenario, md


# ============================================================
# SYSTEM PROMPT
# ============================================================

def build_system_prompt(scenario, md_prompt, archetype_id="novice", level_id="1"):
    """
    –°–æ–±–∏—Ä–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏–∑ JSON-—Å—Ü–µ–Ω–∞—Ä–∏—è + Markdown-–ø—Ä–æ–º–ø—Ç–∞.
    archetype_id / level_id –ø—Ä–∏—Ö–æ–¥—è—Ç —Å CLI –∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ client_behavior_presets.
    """
    profile = scenario.get("client_profile", {}) or {}
    objectives = scenario.get("dialog_objectives", {}) or {}
    compliance = scenario.get("compliance_requirements", {}) or {}
    presets = scenario.get("client_behavior_presets", {}) or {}
    aida = scenario.get("aida_flow", {}) or {}
    scenario_id = scenario.get("scenario_id", "")
    scenario_title = scenario.get("title") or scenario.get("name") or "—Å—Ü–µ–Ω–∞—Ä–∏–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏"

    archetypes = presets.get("archetypes", {}) or {}
    difficulty_levels = presets.get("difficulty_levels", {}) or {}

    archetype = archetypes.get(archetype_id, {}) or {}
    difficulty = difficulty_levels.get(level_id, {}) or {}

    mandatory = normalize_phrases(compliance.get("mandatory_phrases", []))
    forbidden = normalize_phrases(compliance.get("forbidden_phrases", []))

    # –ë–æ–ª–µ–µ —è–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–µ—Ç–∏–ø–∞ / —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –º–æ–¥–µ–ª–∏
    archetype_name = archetype.get("name") or archetype_id
    archetype_personality = archetype.get("personality") or archetype.get("description") or ""
    difficulty_name = difficulty.get("name") or level_id
    difficulty_desc = difficulty.get("description") or ""

    return f"""
–¢—ã ‚Äî –ò–ò-–∫–ª–∏–µ–Ω—Ç –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω–æ–º –∑–≤–æ–Ω–∫–µ —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –ø–æ {scenario_title}.
–°—Ü–µ–Ω–∞—Ä–∏–π: {scenario_id or "–±–µ–∑ —è–≤–Ω–æ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞"}.
–¢–≤–æ–π –∞—Ä—Ö–µ—Ç–∏–ø –∫–ª–∏–µ–Ω—Ç–∞: {archetype_name} (id: {archetype_id}).
–ö—Ä–∞—Ç–∫–æ –æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ –∞—Ä—Ö–µ—Ç–∏–ø–∞: {archetype_personality or "—Å–º. –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∏–∂–µ"}.
–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: {difficulty_name} (id: {level_id}).
–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —ç—Ç–æ—Ç —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ–≤–µ–¥–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞: {difficulty_desc or "—Å–º. –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∏–∂–µ"}.

–ì–æ–≤–æ—Ä–∏—à—å –¢–û–õ–¨–ö–û –æ—Ç –ª–∏—Ü–∞ –∫–ª–∏–µ–Ω—Ç–∞, –≤ –ø–µ—Ä–≤–æ–º –ª–∏—Ü–µ ("—è").
–ù–ò–ö–û–ì–î–ê –Ω–µ –ø–∏—à–µ—à—å —Ä–µ–ø–ª–∏–∫–∏ –∑–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –ø—Ä–µ—Ñ–∏–∫—Å—ã "–ú–µ–Ω–µ–¥–∂–µ—Ä:", "–û–ø–µ—Ä–∞—Ç–æ—Ä:" –∏ —Ç.–ø.

–§–æ—Ä–º–∞—Ç —Ä–µ—á–∏:
- –æ—Ç–≤–µ—á–∞–µ—à—å —Ç–æ–ª—å–∫–æ –Ω–∞ –ü–û–°–õ–ï–î–ù–Æ–Æ —Ñ—Ä–∞–∑—É –º–µ–Ω–µ–¥–∂–µ—Ä–∞;
- 1‚Äì3 –∫–æ—Ä–æ—Ç–∫–∏—Ö, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è;
- –¥–µ–ª–æ–≤–æ–π —Ç–æ–Ω, –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∞—Ä—Ö–µ—Ç–∏–ø–æ–º ({archetype_name}) –∏ –µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º;
- –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±–µ–∑ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.

–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è:
- –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –¥–æ—Å–ª–æ–≤–Ω–æ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–º–µ—á–∞–Ω–∏–µ.
  –ï—Å–ª–∏ —Ç—ã —É–∂–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª —á—Ç–æ-—Ç–æ –≤ –¥—É—Ö–µ "–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –∫–∞–∫–æ–π —Å—á—ë—Ç?" –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å,
  –±–æ–ª—å—à–µ —Ç–∞–∫ –¥–æ—Å–ª–æ–≤–Ω–æ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π, –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∏–ª–∏ –∑–∞–¥–∞–π –Ω–æ–≤—ã–π —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å.
- –ï—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä —É–∂–µ –Ω–∞—á–∞–ª –æ–±—ä—è—Å–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è –∏ –≤—ã–≥–æ–¥—ã, –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∫ —Å–∞–º—ã–º –ø–µ—Ä–≤—ã–º –±–∞–∑–æ–≤—ã–º –≤–æ–ø—Ä–æ—Å–∞–º,
  –ª—É—á—à–µ —É—Ç–æ—á–Ω–∏ –¥–µ—Ç–∞–ª–∏ –∏–ª–∏ –≤—ã—Ä–∞–∑–∏ —Å–æ–º–Ω–µ–Ω–∏—è/–∏–Ω—Ç–µ—Ä–µ—Å.
- –ù–∞ —ç—Ç–∞–ø–µ –¥–µ–π—Å—Ç–≤–∏—è (action) ‚Äî –µ—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –ø–æ–Ω—è—Ç–Ω—ã –∏ –≤ —Ü–µ–ª–æ–º –ø–æ–¥—Ö–æ–¥—è—Ç,
  –ª–æ–≥–∏—á–Ω–æ —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (–≤—Å—Ç—Ä–µ—á–∞, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ, —Ç–µ—Å—Ç),
  –ª–∏–±–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è, –Ω–æ –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∫ —Å–∞–º–æ–º—É –ø–µ—Ä–≤–æ–º—É –≤–æ–ø—Ä–æ—Å—É.

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
- –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è –∞—Ä—Ö–µ—Ç–∏–ø–∞ –∫–ª–∏–µ–Ω—Ç–∞ –∏ —É—Ä–æ–≤–Ω—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏;
- –µ—Å–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –≤—ã—à–µ, –º–æ–∂–µ—à—å –¥–∞–≤–∞—Ç—å –±–æ–ª—å—à–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π, —Å–æ–º–Ω–µ–Ω–∏–π, –≤–æ–ø—Ä–æ—Å–æ–≤;
- –µ—Å–ª–∏ —ç—Ç–æ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π/—Å—Ç—Ä–µ—Å—Å–æ–≤—ã–π –∞—Ä—Ö–µ—Ç–∏–ø ‚Äî –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π —Ç–æ–Ω, –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è, –Ω–æ –±–µ–∑ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã—Ö –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–π.

–ü—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞ (–∫—Ç–æ —Ç—ã –∏ –≤ –∫–∞–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥–∏—à—å—Å—è):
{json.dumps(profile, ensure_ascii=False, indent=2)}

–ê—Ä—Ö–µ—Ç–∏–ø –∫–ª–∏–µ–Ω—Ç–∞ (–æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è, —ç–º–æ—Ü–∏–π –∏ —Å—Ç–∏–ª—è –æ–±—â–µ–Ω–∏—è):
{json.dumps(archetype, ensure_ascii=False, indent=2)}

–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (—á—Ç–æ –æ—Ç —Ç–µ–±—è –æ–∂–∏–¥–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ):
{json.dumps(difficulty, ensure_ascii=False, indent=2)}

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è (Markdown-–ø—Ä–æ–º–ø—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è):
{md_prompt}

–¶–µ–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (—á—Ç–æ –º–µ–Ω–µ–¥–∂–µ—Ä –¥–æ–ª–∂–µ–Ω –æ—Ç—Ä–∞–±–æ—Ç–∞—Ç—å):
{json.dumps(objectives, ensure_ascii=False, indent=2)}

AIDA (—ç—Ç–∞–ø—ã –¥–∏–∞–ª–æ–≥–∞ –∏ –ª–æ–≥–∏–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞):
{json.dumps(aida, ensure_ascii=False, indent=2)}

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –æ–Ω –º–æ–∂–µ—Ç –Ω–∞ –Ω–∏—Ö —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å):
{json.dumps(mandatory, ensure_ascii=False, indent=2)}

–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–∫–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –Ω–∞—Å—Ç–æ—Ä–æ–∂–µ–Ω–Ω–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ —Å–ª—ã—à–∏—Ç –ø–æ–¥–æ–±–Ω–æ–µ):
{json.dumps(forbidden, ensure_ascii=False, indent=2)}
""".strip()


# ============================================================
# –ü–†–û–ú–ü–¢
# ============================================================

def make_prompt(system_prompt, conversation, max_turns=8):
    """
    conversation: [{role: "manager"/"client", text: "..."}]
    –í –ø—Ä–æ–º–ø—Ç –æ—Ç–¥–∞—ë–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ max_turns —Ä–µ–ø–ª–∏–∫.
    –¢–∞–∫–∂–µ —É–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —ç—Ç–∞–ø AIDA, –∏—Å—Ö–æ–¥—è –∏–∑ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ö–æ–¥–æ–≤ –ú–ï–ù–ï–î–ñ–ï–†–ê.
    """
    manager_turns = sum(1 for t in conversation if t["role"] == "manager")
    stage = detect_stage(manager_turns)

    history = conversation[-max_turns:]
    lines = [system_prompt, ""]
    lines.append(f"–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø AIDA (–ø—Ä–∏–º–µ—Ä–Ω–æ): {stage}")
    if stage == "attention":
        lines.append("–ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –∫–ª–∏–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –∑–Ω–∞–∫–æ–º–∏—Ç—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º, –ù–ï –∑–∞–¥–∞—ë—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ–¥–Ω–æ—Ç–∏–ø–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –º–æ–∂–µ—Ç –ø—Ä–æ—è–≤–ª—è—Ç—å –ª—ë–≥–∫–æ–µ –Ω–µ–¥–æ–≤–µ—Ä–∏–µ –∏–ª–∏ —É–¥–∏–≤–ª–µ–Ω–∏–µ.")
    elif stage == "interest":
        lines.append("–ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å –∏ –∑–∞–¥–∞—ë—Ç 1‚Äì2 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞, –Ω–æ –Ω–µ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–º –∏ —Ç–æ–º –∂–µ. –û–Ω —Å—Ç–∞—Ä–∞–µ—Ç—Å—è –ø–æ–Ω—è—Ç—å –≤—ã–≥–æ–¥—ã –∏ —Ä–∏—Å–∫–∏.")
    elif stage == "desire":
        lines.append("–ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –∫–ª–∏–µ–Ω—Ç –æ–±—Å—É–∂–¥–∞–µ—Ç –≤—ã–≥–æ–¥—ã, —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º —Ä–µ—à–µ–Ω–∏–µ–º, –º–æ–∂–µ—Ç –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ —Å–æ–≥–ª–∞—à–∞—Ç—å—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç –∏–ª–∏ —É–≥–ª—É–±–ª—è—Ç—å—Å—è –≤ –¥–µ—Ç–∞–ª–∏.")
    else:
        lines.append("–ù–∞ —ç—Ç–∞–ø–µ action –∫–ª–∏–µ–Ω—Ç –ª–∏–±–æ —Å–æ–≥–ª–∞—à–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (–≤—Å—Ç—Ä–µ—á–∞/–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ/—Ç–µ—Å—Ç), –ª–∏–±–æ –≤–µ–∂–ª–∏–≤–æ –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, –Ω–æ –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ —Å–∞–º—ã–º –ø–µ—Ä–≤—ã–º –≤–æ–ø—Ä–æ—Å–∞–º.")

    lines.append("")
    lines.append("–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–ø–ª–∏–∫–∏):")
    for turn in history:
        role = "–ú–µ–Ω–µ–¥–∂–µ—Ä" if turn["role"] == "manager" else "–ö–ª–∏–µ–Ω—Ç"
        lines.append(f"{role}: {turn['text']}")
    lines.append("")
    lines.append("–û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (1‚Äì3 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è —É–∂–µ –∑–∞–¥–∞–Ω–Ω—ã—Ö –∏–º —Å–∞–º–∏–º –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –±–µ–∑ —Ä–µ–ø–ª–∏–∫ –∑–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞):")
    return "\n".join(lines)


# ============================================================
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –û–¢–í–ï–¢–ê
# ============================================================

def generate_client_reply(system_prompt, conversation, model, last_client_reply: str):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ Ollama, —á–∏—Å—Ç–∏–º, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–≤—Ç–æ—Ä.
    –í–æ–∑–≤—Ä–∞—â–∞–µ–º: (reply, is_repeat, had_reply)
    """
    prompt = make_prompt(system_prompt, conversation)
    result = subprocess.run(
        ["ollama", "run", model],
        input=prompt,
        capture_output=True,
        text=True
    )

    reply = clean_reply(result.stdout)
    if not reply:
        return "", False, False

    simple_prev = re.sub(r"[^\w ]", "", last_client_reply.lower())
    simple_new = re.sub(r"[^\w ]", "", reply.lower())
    is_repeat = bool(simple_prev and simple_new and simple_new == simple_prev)

    return reply, is_repeat, True


# ============================================================
# –ú–ê–†–ö–ï–†–´ –£–°–ü–ï–•–ê
# ============================================================

SUCCESS_MARKERS = [
    "–¥–∞–≤–∞–π—Ç–µ –Ω–∞–∑–Ω–∞—á–∏–º", "–¥–∞–≤–∞–π—Ç–µ –±–ª–∏–∂–µ", "–¥–∞–≤–∞–π—Ç–µ –≤ —Å—Ä–µ–¥—É",
    "–º–æ–∂–µ–º —Å—Ä–∞–∑—É –æ—Ñ–æ—Ä–º–∏—Ç—å", "–≥–æ—Ç–æ–≤ –ø–æ–¥—ä–µ—Ö–∞—Ç—å", "–º–æ–≥—É –ø–æ–¥—ä–µ—Ö–∞—Ç—å",
    "–º–æ–≥—É –ø—Ä–∏–µ—Ö–∞—Ç—å", "–¥–∞–≤–∞–π—Ç–µ –æ—Ñ–æ—Ä–º–∏–º", "–º–µ–Ω—è –≤—Å–µ —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç",
    "–º–µ–Ω—è –≤—Å—ë —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç", "–¥–∞–≤–∞–π—Ç–µ –ø–æ–ø—Ä–æ–±—É–µ–º", "–≥–æ—Ç–æ–≤ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å",
]

NEGATIVE_MARKERS = [
    "–Ω–∏—á–µ–≥–æ –Ω–µ –Ω—É–∂–Ω–æ", "—è –æ—Ç–∫–∞–∑—ã–≤–∞—é—Å—å", "–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ",
    "–º–Ω–µ —ç—Ç–æ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç", "—è –Ω–µ –≥–æ—Ç–æ–≤", "–¥–∞–≤–∞–π—Ç–µ –±–µ–∑ —ç—Ç–æ–≥–æ",
]


# ============================================================
# LIVE MODE
# ============================================================

def run_live(scenario_name, system_prompt, scenario, model):
    conversation = []
    turn_counter = 0
    last_client_reply = ""

    compliance = scenario.get("compliance_requirements", {}) or {}
    forbidden = normalize_phrases(compliance.get("forbidden_phrases", []))
    mandatory = normalize_phrases(compliance.get("mandatory_phrases", []))

    print("–í–≤–µ–¥–∏—Ç–µ 'exit' –¥–ª—è –≤—ã—Ö–æ–¥–∞.\n")

    while True:
        manager_raw = input("–û–ø–µ—Ä–∞—Ç–æ—Ä: ")
        manager = clean_manager_input(manager_raw)

        if manager.lower() in ("exit", "–≤—ã—Ö–æ–¥"):
            print("–î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à—ë–Ω.")
            break

        if not manager:
            continue

        turn_counter += 1
        conversation.append({"role": "manager", "text": manager})

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º forbidden / mandatory –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        for ph in forbidden:
            if ph.lower() in manager.lower():
                print(f"‚ö†Ô∏è –ú–µ–Ω–µ–¥–∂–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ó–ê–ü–†–ï–©–Å–ù–ù–£–Æ —Ñ—Ä–∞–∑—É —Å—Ü–µ–Ω–∞—Ä–∏—è: '{ph}'")
        for ph in mandatory:
            if ph.lower() in manager.lower():
                print(f"‚≠ê –ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–∏–∑–Ω—ë—Å –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–£–Æ —Ñ—Ä–∞–∑—É —Å—Ü–µ–Ω–∞—Ä–∏—è: '{ph}'")

        reply, is_repeat, had_reply = generate_client_reply(system_prompt, conversation, model, last_client_reply)

        if not had_reply:
            print("‚ö†Ô∏è –ú–æ–¥–µ–ª—å –Ω–µ –¥–∞–ª–∞ –≤–Ω—è—Ç–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.\n")
            continue

        if is_repeat:
            print("‚ö†Ô∏è –ö–ª–∏–µ–Ω—Ç –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –æ–¥–Ω—É –∏ —Ç—É –∂–µ —Ñ—Ä–∞–∑—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–¥–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫—Ä–∞—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏—Ç—å —Å—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥).\n")

        print(f"–ö–ª–∏–µ–Ω—Ç: {reply}")
        print("-" * 60)
        print()
        conversation.append({"role": "client", "text": reply})
        last_client_reply = reply

        # –ê–≤—Ç–æ-–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ —Å–º—ã—Å–ª—É
        rl = reply.lower()
        if any(m in rl for m in SUCCESS_MARKERS):
            print("‚úÖ –ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è. –î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à—ë–Ω –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é.")
            break
        if any(m in rl for m in NEGATIVE_MARKERS):
            print("‚ùå –ö–ª–∏–µ–Ω—Ç –≤–µ–∂–ª–∏–≤–æ –æ—Ç–∫–∞–∑–∞–ª—Å—è. –î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à—ë–Ω –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é.")
            break

        # –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
        if turn_counter >= 12:
            print("‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ö–æ–¥–æ–≤. –î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à—ë–Ω —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏.")
            break

    return conversation


# ============================================================
# SCRIPT MODE ‚Äî –ì–û–¢–û–í–´–ô –¢–ï–°–¢–û–í–´–ô –î–ò–ê–õ–û–ì
# ============================================================

TEST_DIALOG_FULL = [
    {
        "manager": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ú–µ–Ω—è –∑–æ–≤—É—Ç –ú–∞—Ä–∏—è, –º–µ–Ω–µ–¥–∂–µ—Ä Ozon. –í–∏–¥–µ–ª–∞, —á—Ç–æ –≤—ã –Ω–µ–¥–∞–≤–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –∫–∞–∫ –ø—Ä–æ–¥–∞–≤–µ—Ü. –ú–æ–≥—É –æ—Ç–≤–ª–µ—á—å –≤–∞—Å –Ω–∞ –ø–∞—Ä—É –º–∏–Ω—É—Ç?",
        "client": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –ú–∞—Ä–∏—è. –î–∞, –º–æ–∂–Ω–æ, —Ç–æ–ª—å–∫–æ –¥–∞–≤–∞–π—Ç–µ –ø–æ —Å—É—Ç–∏, —è —Å–µ–π—á–∞—Å —Å –∑–∞–∫–∞–∑–∞–º–∏ —Ä–∞–∑–±–∏—Ä–∞—é—Å—å."
    },
    {
        "manager": "–ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –≤—ã –ò–ü –∏–ª–∏ –û–û–û –∏ —á—Ç–æ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ?",
        "client": "–Ø –ò–ü, –ø—Ä–æ–¥–∞—é —Ç–æ–≤–∞—Ä—ã –¥–ª—è –¥–æ–º–∞, —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª –∑–∞–≥—Ä—É–∂–∞—Ç—å –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –Ω–∞ Ozon."
    },
    {
        "manager": "–ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ —Ä–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç –∫ –∫–∞–±–∏–Ω–µ—Ç—É –ø—Ä–æ–¥–∞–≤—Ü–∞ –≤—ã –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–ª–∏?",
        "client": "–î–∞, –≤–µ—Ä–Ω–æ, –ø–æ–∫–∞ –ø–æ–ª—å–∑—É—é—Å—å –æ–±—ã—á–Ω—ã–º —Å—á—ë—Ç–æ–º –≤ –¥—Ä—É–≥–æ–º –±–∞–Ω–∫–µ, –¥–æ —ç—Ç–æ–≥–æ —Ä—É–∫–∏ –Ω–µ –¥–æ—à–ª–∏."
    },
    {
        "manager": "–ö–æ—Ä–æ—Ç–∫–æ —Ä–∞—Å—Å–∫–∞–∂—É, –≤ —á—ë–º —Å—É—Ç—å: —Å—á—ë—Ç –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ Ozon, —É–¥–æ–±–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã, —á–∞—Ç —Å –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º–∏ –∏ –æ–Ω–ª–∞–π–Ω-–±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è. –ù–∞—Å–∫–æ–ª—å–∫–æ –¥–ª—è –≤–∞—Å –∞–∫—Ç—É–∞–ª—å–Ω–∞ —Ç–µ–º–∞ –∫–æ–º–∏—Å—Å–∏–∏ –∏ —É–¥–æ–±—Å—Ç–≤–∞ –≤—ã–ø–ª–∞—Ç?",
        "client": "–≠–∫–æ–Ω–æ–º–∏—è –≤—Å–µ–≥–¥–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞, –ø—Ä–æ—Å—Ç–æ –Ω–µ –¥–æ –∫–æ–Ω—Ü–∞ –ø–æ–Ω–∏–º–∞—é, —á–µ–º —ç—Ç–æ—Ç —Å—á—ë—Ç –ª—É—á—à–µ –º–æ–µ–≥–æ —Ç–µ–∫—É—â–µ–≥–æ."
    },
    {
        "manager": "–ú–æ–∂–µ—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω–æ —Å–∫–∞–∑–∞—Ç—å, —Å–∫–æ–ª—å–∫–æ —Å–µ–π—á–∞—Å –ø–ª–∞—Ç–∏—Ç–µ –∑–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∏ –µ—Å—Ç—å –ª–∏ –ª–∏–º–∏—Ç—ã –Ω–∞ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤?",
        "client": "–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –æ–∫–æ–ª–æ —Ç—ã—Å—è—á–∏ –≤ –º–µ—Å—è—Ü, –∏ –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Å—É–º–º–µ –≤—ã–≤–æ–¥–∞, –Ω–æ —Ç–æ—á–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –Ω–µ —Å–∫–∞–∂—É."
    },
    {
        "manager": "–£ –Ω–∞—Å –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –±–µ–∑ –ø–ª–∞—Ç—ã –Ω–∞ –ª—å–≥–æ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥, –ø–ª—é—Å –ø—Ä–æ—Ü–µ–Ω—Ç—ã –Ω–∞ –æ—Å—Ç–∞—Ç–æ–∫ –∏ —á–∞—Ç —Å –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º–∏. –ù–∞—Å–∫–æ–ª—å–∫–æ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –±—ã–ª–æ –±—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å —Ç–µ–∫—É—â–∏–º —Å—á—ë—Ç–æ–º?",
        "client": "–ï—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –∏ –±–µ–∑ —Å–∫—Ä—ã—Ç—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–∂–Ω–æ, –≥–ª–∞–≤–Ω–æ–µ, —á—Ç–æ–±—ã –≤—Å—ë –±—ã–ª–æ —á–µ—Å—Ç–Ω–æ."
    },
    {
        "manager": "–¢–æ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞—é –∫–æ—Ä–æ—Ç–∫—É—é –≤—Å—Ç—Ä–µ—á—É: –ø–æ–∫–∞–∂—É —Ç–∞—Ä–∏—Ñ—ã –∏ –≤—ã —Å—Ä–∞–∑—É —É–≤–∏–¥–∏—Ç–µ —Ü–∏—Ñ—Ä—ã. –ù–∞ –∫–∞–∫–æ–π –¥–µ–Ω—å –≤–∞–º —É–¥–æ–±–Ω–µ–µ ‚Äî –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –Ω–µ–¥–µ–ª–∏ –∏–ª–∏ –±–ª–∏–∂–µ –∫ –∫–æ–Ω—Ü—É?",
        "client": "–î–∞–≤–∞–π—Ç–µ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –Ω–µ–¥–µ–ª–∏, –≤ —Å—Ä–µ–¥—É –ø–æ—Å–ª–µ –æ–±–µ–¥–∞. –ï—Å–ª–∏ –≤—Å—ë —É—Å—Ç—Ä–æ–∏—Ç –ø–æ —É—Å–ª–æ–≤–∏—è–º, –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —Å—Ä–∞–∑—É –æ—Ñ–æ—Ä–º–∏—Ç—å."
    }
]


def run_script(scenario_name):
    conversation = []

    print("–¢–µ—Å—Ç–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ (–±–µ–∑ –≤—ã–∑–æ–≤–∞ –º–æ–¥–µ–ª–∏):\n")

    for turn in TEST_DIALOG_FULL:
        print("–û–ø–µ—Ä–∞—Ç–æ—Ä:", turn["manager"])
        print("–ö–ª–∏–µ–Ω—Ç:  ", turn["client"], "\n")
        conversation.append({"role": "manager", "text": turn["manager"]})
        conversation.append({"role": "client", "text": turn["client"]})

    return conversation


# ============================================================
# FILE MODE ‚Äî –ü–û–°–¢–†–û–ß–ù–û–ï –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï
# ============================================================

def run_file_mode(scenario_name, system_prompt, scenario, model, file_path):
    conversation = []
    turn_counter = 0
    last_client_reply = ""

    compliance = scenario.get("compliance_requirements", {}) or {}
    forbidden = normalize_phrases(compliance.get("forbidden_phrases", []))

    with open(file_path, "r", encoding="utf-8") as f:
        for line in f:
            manager_raw = line.strip()
            manager = clean_manager_input(manager_raw)
            if not manager:
                continue

            print(f"–û–ø–µ—Ä–∞—Ç–æ—Ä: {manager}")
            conversation.append({"role": "manager", "text": manager})

            for ph in forbidden:
                if ph.lower() in manager.lower():
                    #print(f"‚ö†Ô∏è –ó–∞–ø—Ä–µ—â—ë–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞: {ph}")

            reply, is_repeat, had_reply = generate_client_reply(system_prompt, conversation, model, last_client_reply)

            if not had_reply:
                #print("‚ö†Ô∏è –ú–æ–¥–µ–ª—å –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∞.\n")
                continue

            if is_repeat:
                print("‚ö†Ô∏è –ö–ª–∏–µ–Ω—Ç –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –æ–¥–Ω—É –∏ —Ç—É –∂–µ —Ñ—Ä–∞–∑—É, –º–µ–Ω–µ–¥–∂–µ—Ä—É —Å—Ç–æ–∏—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é.\n")

            print(f"–ö–ª–∏–µ–Ω—Ç:   {reply}")
            print("-" * 60)
            print()
            conversation.append({"role": "client", "text": reply})
            last_client_reply = reply

            turn_counter += 1
            if turn_counter >= 12:
                #print("‚ö†Ô∏è –õ–∏–º–∏—Ç —Ö–æ–¥–æ–≤, –¥–∏–∞–ª–æ–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
                break

    return conversation


# ============================================================
# MAIN
# ============================================================

def run_dialog(
    scenario_name: str,
    model: str,
    mode: str,
    file_path=None,
    archetype_id: str = "novice",
    level_id: str = "1",
):
    scenario, md = load_scenario(scenario_name)
    system_prompt = build_system_prompt(scenario, md, archetype_id=archetype_id, level_id=level_id)

    print(f"üéôÔ∏è –°—Ü–µ–Ω–∞—Ä–∏–π: {scenario_name}")
    print(f"üë§ –ê—Ä—Ö–µ—Ç–∏–ø: {archetype_id} |   –°–ª–æ–∂–Ω–æ—Å—Ç—å: {level_id}\n")

    if mode == "script":
        conv = run_script(scenario_name)

    elif mode == "file":
        if not file_path:
            raise ValueError("file mode requires --file path")
        conv = run_file_mode(scenario_name, system_prompt, scenario, model, file_path)

    else:  # live
        conv = run_live(scenario_name, system_prompt, scenario, model)

    # save
    os.makedirs("logs", exist_ok=True)
    timestamp = time.strftime("%Y%m%d_%H%M%S")
    save_path = f"logs/dialog_{scenario_name}_{mode}_{archetype_id}_L{level_id}_{timestamp}.json"

    log_payload = {
        "scenario_name": scenario_name,
        "scenario_id": scenario.get("scenario_id"),
        "mode": mode,
        "model": model,
        "archetype_id": archetype_id,
        "difficulty_level_id": level_id,
        "turns": conv,
    }

    with open(save_path, "w", encoding="utf-8") as f:
        json.dump(log_payload, f, ensure_ascii=False, indent=2)
    print(f"üíæ –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {save_path}")


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--scenario", required=True, help="–∏–º—è —Å—Ü–µ–Ω–∞—Ä–∏—è –±–µ–∑ .json (ozon_rko_new_seller)")
    parser.add_argument("--model", default="qwen2.5:14b-instruct-q4_K_M")
    parser.add_argument("--mode", choices=["live", "script", "file"], default="live")
    parser.add_argument("--file", help="—Ñ–∞–π–ª —Å —Ä–µ–ø–ª–∏–∫–∞–º–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ file")
    parser.add_argument("--archetype", default="novice", help="id –∞—Ä—Ö–µ—Ç–∏–ø–∞ –∏–∑ client_behavior_presets.archetypes")
    parser.add_argument("--difficulty", default="1", help="id —É—Ä–æ–≤–Ω—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏–∑ client_behavior_presets.difficulty_levels")
    args = parser.parse_args()

    run_dialog(
        args.scenario,
        args.model,
        args.mode,
        args.file,
        archetype_id=args.archetype,
        level_id=args.difficulty,
    )